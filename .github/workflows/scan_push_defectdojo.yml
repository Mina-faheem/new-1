
name: t-2-d

on:
  push:
    branches: [main]
  pull_request:

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create results directory
        run: mkdir -p trivy-results sbom

      - name: Set up Trivy
        uses: aquasecurity/setup-trivy@v0.2.1
        with:
          trivy-version: '0.56.1'

      - name: Cache Trivy binary
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/trivy-bin
          key: trivy-binary-v0.56.1-Linux-X64

      - name: Trivy Filesystem Scan (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: '.'
          format: json
          output: trivy-results/fs-scan.json
          exit-code: 0

      - name: Trivy Repository Scan (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: repo
          scan-ref: '.'
          format: json
          output: trivy-results/repo-scan.json
          exit-code: 0

      - name: Trivy IaC Scan (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: config
          scan-ref: '.'
          format: json
          output: trivy-results/iac-scan.json
          exit-code: 0

      - name: Trivy Secret Scan (JSON)
        run: trivy fs --scanners secret --format json . > trivy-results/secret-scan.json

      - name: Upload Trivy Filesystem Scan to DefectDojo
        run: |
          curl -X POST "http://0f1dcdfc472c.mylabserver.com:8080/api/v2/import-scan/" \
            -H "Authorization: Token c0706cb1cb1984fea533b8a38ab3d16306777f9e" \
            -F "scan_type=Trivy Scan" \
            -F "file=@trivy-results/fs-scan.json" \
            -F "engagement=1" \
            -F "minimum_severity=Low" \
            -F "active=true" \
            -F "verified=true" \
            -F "scan_date=$(date +%F)" \
            -F "close_old_findings=true"
        env:
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}

      - name: Upload Trivy Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-results/
            sbom/

      - name: Summarize Trivy Scan Results
        if: always()
        run: |
          echo "üîç Trivy Scan Summary"
          echo "======================"
          echo "üõ†Ô∏è Filesystem Scan:"
          jq '.' trivy-results/fs-scan.json || echo "No filesystem scan results found."

          echo "üì¶ Repository Scan:"
          jq '.' trivy-results/repo-scan.json || echo "No repository scan results found."

          echo "‚öôÔ∏è IaC Scan:"
          jq '.' trivy-results/iac-scan.json || echo "No IaC scan results found."

          echo "üîê Secret Scan:"
          jq '.' trivy-results/secret-scan.json || echo "No secret scan results found."
